<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="com.goody.diet.cart.CartDAO">
	
	<select id="getCartList" parameterType="CartDTO" resultMap="CartDTOMap">
		SELECT C.*,S.*,SF.*
		FROM CART C
			LEFT JOIN
			STUDY S
			ON (C.STUDYNUM = S.STUDYNUM)
			LEFT JOIN
			STUDYFILE SF
			ON (S.STUDYNUM = SF.STUDYNUM) 
		WHERE C.ID=#{id}
		ORDER BY C.NUM ASC
	</select>
	
	<select id="getPaymentList" parameterType="CartDTO" resultMap="CartDTOMap">
		SELECT C.*,S.*,SF.*
		FROM CART C
			LEFT JOIN
			STUDY S
			ON (C.STUDYNUM = S.STUDYNUM)
			LEFT JOIN
			STUDYFILE SF
			ON (S.STUDYNUM = SF.STUDYNUM) 
		WHERE C.ID=#{id} AND C.STATUS=1
		ORDER BY C.NUM ASC
	</select>

	
	<insert id="setCartStudyAdd" parameterType="CartDTO">
		INSERT INTO CART (NUM,ID,STUDYNUM,COUNT,STATUS,CARTPRICE)
		VALUES (CART_SEQ.NEXTVAL,#{id},#{studyNum},#{count},#{status}, #{cartPrice})
	</insert>
	
	<update id="setCartCheckUpdate" parameterType="long">
		UPDATE CART SET STATUS=1 WHERE  NUM=#{num}
	</update>
	
	<update id="setCartUnCheckUpdate" parameterType="long">
		UPDATE CART SET STATUS=0 WHERE  NUM=#{num}
	</update>
	
	<!-- 태현 -->
	<insert id="setCartMachineAdd" parameterType="CartDTO">
		insert into Cart(num,id,studynum,realmachinenum, COUNT)
		VALUES (CART_SEQ.NEXTVAL,#{id},#{studyNum,jdbcType=INTEGER},#{realMachineNum,jdbcType=INTEGER},#{count})
	</insert>
	<update id="setCartMachineCount" parameterType="CartDTO">
	UPDATE CART SET "COUNT"="COUNT"+1 WHERE REALMACHINENUM=#{realMachineNum}
	</update>
	
	<delete id="setCartDelete" parameterType="Long">
		DELETE CART WHERE NUM=#{num}
	</delete>

	<resultMap id="CartDTOMap" type="CartDTO">
		<id column="num" property="num" />
			<result column="id" property="id" />
			<result column="realMachineNum" property="realMachineNum" />
			<result column="studyNum" property="studyNum" />
			<result column="count" property="count" />
			<result column="status" property="status" />
			<result column="cartPrice" property="cartPrice" />
		<collection property="studyDTOs" ofType="StudyDTO">
			<id column="studyNum" property="studyNum" />
				<result column="studyName" property="studyName" />
				<result column="studyCost" property="studyCost" />
				<result column="studyStartPeriod" property="studyStartPeriod" />
				<result column="studyEndPeriod" property="studyEndPeriod" />
				<result column="studyStock" property="studyStock" />
			<collection property="studyBoardFileDTOs" javaType="List"  ofType="StudyBoardFileDTO">
				<id column="fileNum" property="fileNum" />
					<result column="fileName" property="fileName" />
					<result column="oriName" property="oriName"/>
			</collection>
		</collection>
	</resultMap>
		 
 </mapper>
