<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.goody.diet.exercise.ExerciseDAO">
   
  <!-- BODY Table List : BODYNUM , NUM --> 
  <select id="getBodyList" resultType="bodyDTO">
		SELECT * FROM BODY
		ORDER BY BODYNUM
	</select>	
<!-- BODYNUM NUM 일치하는 정보 가져오기 -->
  <select id="getBodyDetail" parameterType="ExerciseDTO" resultType="BodyDTO"	>
	SELECT * FROM BODY WHERE BODYNUM IN (SELECT BODYNUM FROM EXERCISEROLE EXR WHERE NUM = #{num})
  </select>
	<!-- 부위별 리스트 + IMG + 영상 조인 리스트 -->
	<select id="getExerciseTypeList" resultMap="getExerciseResult" parameterType="exerciseDTO">
		SELECT * FROM
		EXERCISE EX
		LEFT OUTER JOIN
		(
		SELECT * FROM (
		SELECT
		EXI.*,rank()over(PARTITION BY NUM ORDER BY FILENUM ASC) RANKNUM
		FROM EXERCISEIMG EXI
		) WHERE RANKNUM=1) B
		on(EX.NUM=B.NUM)
		INNER JOIN
		BODY B
		ON(B.NUM=EX.NUM)
		WHERE
		B.BODYNUM=#{bodyNum}
	</select>
<!-- FILE 이랑 EXERCISE -->
	<select id="getExerciseDetail" parameterType="ExerciseDTO" resultMap="getExerciseResult">
		SELECT * FROM EXERCISE EX
		LEFT OUTER JOIN
		EXERCISEIMG EXI
		ON(EX.NUM=EXI.NUM)
		WHERE
		EX.NUM =#{num}
		ORDER BY FILENUM
	</select>
	<select id="getExerciseList" resultMap="getExerciseResult">
	SELECT * FROM EXERCISE EX
		LEFT OUTER JOIN
		(
		SELECT * FROM (
		SELECT m2.*,rank()over(PARTITION BY NUM ORDER BY filenum ASC)
		ranknum
		FROM EXERCISEIMG m2
		) WHERE ranknum=1) t
		on(EX.NUM=t.num)
	</select>
	
	<resultMap type="ExerciseDTO" id="getExerciseResult">
		<id column="NUM" property="num"/>
		<result column="machineNum" property="machineNum"/>
		<result column="urlId" property="urlId"/>
		<result column="power" property="power"/>
		<result column="bodyPart" property="bodyPart"/>
		<result column="time" property="time"/>
		<result column="detailTitle" property="detailTitle"/>
		<result column="info" property="info"/>
		<result column="highLight" property="highLight"/>
		<collection property="bodyDTO" javaType="list" ofType="BodyDTO">
			<id column="bodyNum" property="bodyNum"/>
			<result column="bodyName" property="bodyName"/> 
		</collection>
		<collection property="boardFileDTOs" javaType="list" ofType="BoardFileDTO">
			<id column="fileNum" property="fileNum"/>
	  			<result column="fileName" property="fileName"/>
	  			<result column="oriName" property="oriName"/>
		</collection>
	</resultMap>

  		<insert id="setExerciseAdd" parameterType="ExerciseDTO">
		<selectKey keyProperty="num" resultType="Long" order="BEFORE">
		  			SELECT EXERCISE_SEQ.NEXTVAL FROM DUAL
	  	</selectKey>
		INSERT INTO EXERCISE (NUM, MACHINENUM, URLID, POWER, BODYPART, TIME, detailTitle, INFO)
		VALUES(#{num}, #{machineNum}, #{urlId}, #{power}, #{bodyPart}, #{time}, #{detailTitle}), #{info})
		</insert>
		<insert id="setExerciseImg" parameterType="BoardFileDTO">
			INSERT INTO EXERCISEIMG(FILENUM, NUM, FILENAME, ORINAME)
			VALUES(IMG_SEQ.NEXTVAL,#{num},#{fileName},#{oriName})
		</insert>
		
		<select id ="getExerciseMachine" resultMap="getHealthMachineResult">
			SELECT DISTINCT * FROM HEALTHMACHINE H 
			LEFT OUTER JOIN
			EXERCISE EX
			ON (EX.MACHINENUM = H.MACHINENUM)
		</select>
		<resultMap type="ExerciseDTO" id="getHealthMachineResult">
			<id column="num" property="num"/>
			<result column="machineNum" property="machineNum"/> 
			<result column="urlId" property="urlId"/>
			<result column="power" property="power"/>
			<result column="bodyPart" property="bodyPart"/>
			<result column="time" property="time"/>
			<result column="detailTitle" property="detailTitle"/>
			<result column="highLight" property="highLight"/>
			<result column="info" property="info"/>
			<collection property="healthMachineDTOs" javaType="list" ofType="healthMachineDTO">
				<id column="machineNum" property="machineNum"/>
		  			<result column="machineName" property="machineName"/>
			</collection>
		</resultMap> 

	<delete id="setExercsieDelete" parameterType="ExerciseDTO">
  		DELETE EXERCISE WHERE NUM=#{num}
  	</delete>
  	
  	<select id="getExerciseFileList" parameterType="BoardFileDTO" resultType="BoardFileDTO">
  		SELECT * FROM EXERCISEFILES WHERE NUM=#{num}
  	</select>
    <select id="getExerciseFileDetail" parameterType="BoardFileDTO" resultType="BoardFileDTO">
  		SELECT * FROM EXERCISEFILES WHERE FILENUM=#{fileNum}
  	</select>
 </mapper>
<!-- detail : urlId만 뽑아오기-->
	<!-- <select id="getExerciseBody" parameterType="ExerciseDTO" resultType="ExerciseDTO">
		SELECT * FROM EXERCISE WHERE BODYPART = #{bodyPart}
	</select>	
 -->
<!-- 영상 가져오기 -->	
 	